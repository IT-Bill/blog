---
import '../styles/global.css';
import { Navbar } from '../components/Navbar';
import { Sidebar } from '../components/Sidebar';
import { ArrowUp } from 'lucide-react';
import { getCollection } from 'astro:content';
import type { Post } from '../types';
import { ClientRouter } from 'astro:transitions';

interface Props {
	title?: string;
	showSidebar?: boolean;
}

const { title = "Bill的小破站", showSidebar = true } = Astro.props;
const pageTitle = title === "Bill的小破站" ? title : `${title} | Bill的小破站`;

// 获取所有文章用于侧边栏
const allPosts = await getCollection('posts');
const posts: Post[] = allPosts.map(post => ({
	id: post.id,
	title: post.data.title,
	summary: post.data.summary,
	date: post.data.date,
	category: post.data.category,
	cover: post.data.cover,
	tags: post.data.tags,
	views: post.data.views,
	comments: post.data.comments,
})).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/blog/favicon.svg" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet" />
		<meta name="generator" content={Astro.generator} />
		<title>{pageTitle}</title>
		<ClientRouter />
	</head>
	<body>
		<!-- Loading progress bar -->
		<div id="loading-progress" class="loading-progress">
			<div class="loading-progress-bar"></div>
		</div>

		<!-- Shooting stars background effect -->
		<div class="shooting-stars">
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
			<div class="star"></div>
		</div>

		<div class="min-h-screen pb-12">
			<Navbar client:load />

			<main class="container mx-auto px-4 md:px-6 pt-18">
				<div class={showSidebar ? "grid grid-cols-1 lg:grid-cols-12 gap-6" : ""}>
					
					{showSidebar && (
						<!-- Sidebar (Sticky) -->
						<div class="lg:col-span-3 hidden lg:block">
							<div class="sticky top-14">
								<Sidebar posts={posts} client:load />
							</div>
						</div>
					)}

					<!-- Main Content -->
					<div id="main-content" class={showSidebar ? "lg:col-span-9 min-h-[80vh]" : ""}>
						<slot />
					</div>

					{showSidebar && (
						<!-- Mobile Sidebar -->
						<div class="lg:hidden">
							<Sidebar posts={posts} client:load />
						</div>
					)}

				</div>
			</main>

			<!-- Footer -->
			<footer class="mt-20 text-center text-xs text-dimmed pb-8">
				<p>© 2025 • Bill的小破站 • Powered by Astro</p>
				<p class="mt-1">建站 1506 天 03 时 59 分 27 秒</p>
			</footer>

			<!-- Back to top button -->
			<button 
				id="back-to-top"
				class="fixed bottom-8 right-8 p-3 bg-accent/80 hover:bg-accent text-white rounded-full shadow-lg backdrop-blur-sm transition-all z-40 hidden md:block"
			>
				<ArrowUp size={20} client:load />
			</button>
		</div>

		<script>
			function initBackToTop() {
				document.getElementById('back-to-top')?.addEventListener('click', () => {
					window.scrollTo({top: 0, behavior: 'smooth'});
				});
			}
			
			// 初始化
			initBackToTop();
			
			// 视图过渡后重新初始化
			document.addEventListener('astro:after-swap', initBackToTop);
		</script>

		<script>
			// View transition loading effect
			document.addEventListener('astro:before-preparation', () => {
				const progressBar = document.getElementById('loading-progress');
				const mainContent = document.getElementById('main-content');
				
				if (progressBar) {
					progressBar.classList.add('loading');
				}
				
				if (mainContent) {
					mainContent.classList.add('navigating');
				}
			});

			document.addEventListener('astro:after-swap', () => {
				const progressBar = document.getElementById('loading-progress');
				const mainContent = document.getElementById('main-content');
				
				if (progressBar) {
					progressBar.classList.remove('loading');
					progressBar.classList.add('complete');
					setTimeout(() => {
						progressBar.classList.remove('complete');
					}, 300);
				}
				
				if (mainContent) {
					mainContent.classList.remove('navigating');
				}
			});
		</script>
	</body>
</html>

<style is:global>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}

	/* Loading progress bar */
	.loading-progress {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 3px;
		z-index: 9999;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.2s ease;
	}

	.loading-progress-bar {
		height: 100%;
		width: 0%;
		background: linear-gradient(90deg, var(--color-accent) 0%, #93c5fd 50%, var(--color-accent) 100%);
		background-size: 200% 100%;
		box-shadow: 0 0 10px var(--color-accent), 0 0 20px var(--color-accent);
		border-radius: 0 2px 2px 0;
		transition: width 0.3s ease;
	}

	.loading-progress.loading {
		opacity: 1;
	}

	.loading-progress.loading .loading-progress-bar {
		width: 70%;
		animation: loading-shimmer 1.5s ease-in-out infinite;
	}

	.loading-progress.complete .loading-progress-bar {
		width: 100%;
		transition: width 0.2s ease;
	}

	.loading-progress.complete {
		opacity: 0;
		transition: opacity 0.3s ease 0.1s;
	}

	@keyframes loading-shimmer {
		0% {
			background-position: 200% 0;
		}
		100% {
			background-position: -200% 0;
		}
	}

	/* Main content navigation transition */
	#main-content {
		transition: transform 0.3s ease, opacity 0.3s ease;
		transform-origin: center top;
	}

	#main-content.navigating {
		transform: scale(0.9);
		opacity: 0.4;
	}
</style>
